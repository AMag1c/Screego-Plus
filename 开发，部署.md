# 开发

## 开发环境启动

### 方法1：分离启动前后端（推荐）

**前端（终端1）：**
```bash
cd ui
npm install
npm start  # 启动在 localhost:9100
```

**后端（终端2）：**
```bash
go run main.go serve  # 启动在 localhost:9101
```

### 方法2：使用start.go统一启动

```bash
# 需要先构建前端
cd ui
npm run build
cd ..

# 启动
go run start.go  # 会自动打开浏览器
```

### 方法3：使用环境变量覆盖配置

临时修改某些配置：

```bash
# 覆盖日志级别
SCREEGO_LOG_LEVEL=debug go run main.go serve

# 覆盖TURN端口范围
SCREEGO_TURN_PORT_RANGE=60000:60100 go run main.go serve
```

### 方法4：指定不同的配置文件

如果你有多个配置文件（如生产环境配置）：

```bash
# 使用环境变量指定配置文件
SCREEGO_CONFIG_FILE=screego.config.production go run main.go serve
```

---

# 生产环境部署

## 架构说明

生产环境采用**Docker + Nginx**的双容器架构：

```
宿主机 (域名: wheelchairmagic.site)
├── Nginx (宿主机，端口80/443) ← SSL终止，反向代理
│   ├── / → localhost:9100 (前端容器)
│   ├── /config → localhost:9101 (后端容器)
│   ├── /rooms → localhost:9101
│   └── /stream → localhost:9101 (WebSocket)
│
└── Docker
    ├── screego-frontend 容器 (端口9100) - React前端
    └── screego-backend 容器 (端口9101 + 3478 + 50000-50100) - Go后端 + TURN服务器
```

---

## 部署步骤

### 1. 服务器准备

**系统要求：**
- Ubuntu 20.04+ / Debian 11+
- 4核4GB内存 + 15Mbps带宽（推荐配置）

**安装必要软件：**
```bash
# 更新系统
sudo apt-get update

# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo systemctl start docker
sudo systemctl enable docker

# 安装Docker Compose
sudo apt-get install docker-compose-plugin

# 安装Nginx
sudo apt-get install nginx
sudo systemctl start nginx
sudo systemctl enable nginx

# 安装SSL证书工具
sudo apt-get install certbot python3-certbot-nginx
```

---

### 2. 上传项目文件

```bash
# 在服务器上创建目录
sudo mkdir -p /opt/Screego-Plus
cd /opt/Screego-Plus

# 上传项目文件（方式1：使用scp）
# 在本地机器运行：
scp -r E:\Program_code\screego/* root@你的服务器IP:/opt/Screego-Plus/

# 或方式2：使用git
git clone https://github.com/你的用户名/Screego-Plus.git
cd Screego-Plus
```

---

### 3. 配置环境变量

```bash
cd /opt/Screego-Plus

# 创建.env文件
cp .env.example .env

# 编辑.env文件
nano .env
```

**修改内容：**
```bash
# 重要：替换为你的服务器公网IP地址
SCREEGO_EXTERNAL_IP=你的服务器公网IP
```

---

### 4. 启动Docker容器

```bash
cd /opt/Screego-Plus

# 构建并启动容器
sudo docker-compose up -d --build

# 查看容器状态
sudo docker-compose ps

# 查看日志（可选）
sudo docker-compose logs -f screego-backend
sudo docker-compose logs -f screego-frontend
```

**预期结果：**
```
NAME               STATUS
screego-backend    Up
screego-frontend   Up
```

---

### 5. 配置Nginx反向代理

```bash
# 复制nginx配置
sudo cp /opt/Screego-Plus/nginx-screego.conf /etc/nginx/sites-available/screego

# 编辑配置，修改域名
sudo nano /etc/nginx/sites-available/screego
# 将第9行的 your-domain.com 改为你的域名（如 wheelchairmagic.site）

# 删除默认配置
sudo rm /etc/nginx/sites-enabled/default

# 创建软链接
sudo ln -s /etc/nginx/sites-available/screego /etc/nginx/sites-enabled/

# 测试nginx配置
sudo nginx -t

# 重启nginx
sudo systemctl restart nginx
```

---

### 6. 配置SSL证书

**如果使用Cloudflare代理：**
1. 先在Cloudflare面板将A记录改为**灰色云朵**（仅DNS模式）
2. 等待1-2分钟DNS生效

**申请Let's Encrypt免费SSL证书：**
```bash
sudo certbot --nginx -d 你的域名

# 按提示操作：
# 1. 输入邮箱地址
# 2. 同意服务条款 (Y)
# 3. 是否接收营销邮件 (N)
```

**预期输出：**
```
Successfully deployed certificate for 你的域名
Congratulations! You have successfully enabled HTTPS
```

**证书自动续期：**
```bash
# certbot会自动设置cron任务，测试自动续期：
sudo certbot renew --dry-run
```

---

### 7. Cloudflare配置（可选）

如果使用Cloudflare CDN：

**DNS记录配置：**
```
类型: A
名称: @
内容: 你的服务器公网IP
代理状态: 已代理（橙色云朵）← SSL配置完成后再开启
TTL: 自动
```

**SSL/TLS设置：**
- SSL/TLS加密模式：选择 **完全（严格）**
- 最小TLS版本：TLS 1.2

**开启代理：**
- SSL证书配置完成后，将A记录改为**橙色云朵**（已代理）
- 享受CDN加速和DDoS防护

---

## 验证部署

### 1. 检查服务状态

```bash
# 检查Docker容器
sudo docker-compose ps

# 检查nginx
sudo systemctl status nginx

# 检查端口监听
sudo ss -tlnp | grep :80
sudo ss -tlnp | grep :443
sudo ss -tlnp | grep :9100
sudo ss -tlnp | grep :9101
sudo ss -tlnp | grep :3478
```

### 2. 本地测试

```bash
# 测试前端
curl -I http://localhost:9100

# 测试后端API
curl -I http://localhost:9101/config

# 测试HTTPS
curl -I https://你的域名
```

### 3. 浏览器访问

打开浏览器访问：
```
https://你的域名
```

应该能看到Screego登录页面。

---

## 常用管理命令

### Docker容器管理

```bash
# 查看容器状态
sudo docker-compose ps

# 查看日志
sudo docker-compose logs -f
sudo docker-compose logs -f screego-backend
sudo docker-compose logs -f screego-frontend

# 重启服务
sudo docker-compose restart
sudo docker-compose restart screego-backend

# 停止服务
sudo docker-compose stop

# 启动服务
sudo docker-compose start

# 停止并删除容器
sudo docker-compose down

# 重新构建并启动
sudo docker-compose up -d --build

# 查看资源使用
sudo docker stats
```

### Nginx管理

```bash
# 测试配置
sudo nginx -t

# 重启nginx
sudo systemctl restart nginx

# 重载配置（无需停机）
sudo systemctl reload nginx

# 查看nginx状态
sudo systemctl status nginx

# 查看错误日志
sudo tail -f /var/log/nginx/error.log

# 查看访问日志
sudo tail -f /var/log/nginx/screego_access.log
```

### SSL证书管理

```bash
# 查看证书信息
sudo certbot certificates

# 手动续期
sudo certbot renew

# 测试续期
sudo certbot renew --dry-run

# 删除证书
sudo certbot delete --cert-name 你的域名
```

---

## 更新部署

### 更新代码

```bash
cd /opt/Screego-Plus

# 方式1：上传新文件
# 先在本地打包，然后上传覆盖

# 方式2：使用git
git pull origin master

# 重新构建并启动
sudo docker-compose down
sudo docker-compose up -d --build

# 查看日志确认启动成功
sudo docker-compose logs -f
```

### 更新依赖

```bash
# 更新前端依赖
cd /opt/Screego-Plus/ui
sudo docker-compose run --rm screego-frontend npm update

# 更新Go依赖
cd /opt/Screego-Plus
sudo docker-compose run --rm screego-backend go get -u ./...

# 重新构建
sudo docker-compose up -d --build
```

---

## 故障排查

### 后端容器一直重启

查看日志：
```bash
sudo docker-compose logs screego-backend
```

常见问题：
1. **CORS正则错误**：检查 `docker-compose.yml` 中的 `SCREEGO_CORS_ALLOWED_ORIGINS` 是否为 `.*`（不是`*`）
2. **端口被占用**：检查9101、3478端口是否被其他程序占用
3. **权限问题**：确保Docker有权限访问所需端口

### 前端无法访问

```bash
# 检查前端容器
sudo docker-compose logs screego-frontend

# 检查nginx配置
sudo nginx -t
sudo systemctl status nginx

# 检查端口
sudo ss -tlnp | grep :9100
```

### WebSocket连接失败

检查：
1. Nginx配置中 `/stream` 路由的WebSocket支持
2. 防火墙是否开放3478端口
3. Cloudflare的WebSocket设置（如果使用）

### SSL证书申请失败

常见原因：
1. **Cloudflare代理开启**：申请证书前必须关闭（改为灰色云朵）
2. **防火墙阻止80端口**：Let's Encrypt需要通过80端口验证
3. **DNS未生效**：等待DNS解析生效（通常5-30分钟）

解决方法：
```bash
# 1. 关闭Cloudflare代理（改为灰色云朵）
# 2. 等待2分钟
# 3. 重新申请
sudo certbot --nginx -d 你的域名
```

---

## 性能优化

### 调整TURN端口范围

根据并发用户数调整：
```yaml
# docker-compose.yml
environment:
  - SCREEGO_TURN_PORT_RANGE=50000:50200  # 增加到200个端口
ports:
  - "50000-50200:50000-50200/udp"
```

### 调整Docker资源限制

```yaml
# docker-compose.yml
services:
  screego-backend:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
```

### Nginx缓存优化

编辑 `/etc/nginx/sites-available/screego`，在location块中添加：
```nginx
# 静态资源缓存
location /assets/ {
    proxy_pass http://127.0.0.1:9100;
    proxy_cache_valid 200 1d;
    expires 1d;
    add_header Cache-Control "public, immutable";
}
```

---

## 备份与恢复

### 备份

```bash
# 备份配置文件
tar -czf screego-backup-$(date +%Y%m%d).tar.gz \
  /opt/Screego-Plus/.env \
  /opt/Screego-Plus/docker-compose.yml \
  /etc/nginx/sites-available/screego \
  /etc/letsencrypt/

# 下载到本地
scp root@服务器IP:/root/screego-backup-*.tar.gz ./
```

### 恢复

```bash
# 上传备份文件
scp screego-backup-*.tar.gz root@服务器IP:/root/

# 解压恢复
tar -xzf screego-backup-*.tar.gz -C /
sudo docker-compose up -d --build
sudo systemctl restart nginx
```

---

## 安全建议

1. **定期更新系统**
   ```bash
   sudo apt-get update && sudo apt-get upgrade
   ```

2. **限制SSH访问**
   - 使用SSH密钥认证
   - 禁用root密码登录
   - 修改SSH默认端口

3. **监控日志**
   ```bash
   # 定期检查异常访问
   sudo tail -f /var/log/nginx/screego_access.log
   ```

4. **设置自动更新SSL证书**
   ```bash
   # certbot已自动配置cron任务
   sudo systemctl status certbot.timer
   ```